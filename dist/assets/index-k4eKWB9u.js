var e=Object.defineProperty,t=(t,s,i)=>((t,s,i)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i)(t,"symbol"!=typeof s?s+"":s,i);import{p as s}from"./phaser-DJc9ez-r.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();class i extends s.Scene{constructor(){super("Boot")}create(){this.scene.start("Preloader")}}const a="/boom/";class o extends s.Scene{constructor(){super("Preloader")}preload(){this.add.text(this.cameras.main.centerX,this.cameras.main.centerY,"LOADING GAME ...").setFontFamily('"BitBold", "Tahoma"').setFontSize(15).setColor("white").setStroke("black",2.5).setOrigin(.5,.5),this.load.tilemapTiledJSON("world",`${a}game/map/tilemap.json`),this.load.image("tilemap",`${a}game/map/hard-wall.png`),this.load.image("door",`${a}game/images/door.png`),this.load.image("bomb-up",`${a}game/images/power-up/bomb-up.png`),this.load.image("fire-up",`${a}game/images/power-up/fire-up.png`),this.load.image("remote-control",`${a}game/images/power-up/remote-control.png`),this.load.image("menu-title",`${a}game/images/menu-title.png`),this.load.spritesheet("bomberman-move",`${a}game/sprites/player/walking.png`,{frameWidth:16,frameHeight:16}),this.load.spritesheet("bomberman-dead",`${a}game/sprites/player/killing.png`,{frameWidth:16,frameHeight:21}),this.load.spritesheet("bomb",`${a}game/sprites/bomb/bomb.png`,{frameWidth:17,frameHeight:18}),this.load.spritesheet("wall",`${a}game/sprites/wall/wall.png`,{frameWidth:16,frameHeight:16}),this.load.spritesheet("wall-explosion",`${a}game/sprites/wall/wall-explosion.png`,{frameWidth:18,frameHeight:16}),this.load.spritesheet("ballom",`${a}game/sprites/enemies/ballom.png`,{frameWidth:16,frameHeight:16}),this.load.spritesheet("onil",`${a}game/sprites/enemies/onil.png`,{frameWidth:16,frameHeight:16}),this.load.spritesheet("minvo",`${a}game/sprites/enemies/minvo.png`,{frameWidth:17,frameHeight:16}),this.load.spritesheet("dahl",`${a}game/sprites/enemies/dahl.png`,{frameWidth:18,frameHeight:16}),this.load.spritesheet("ovape",`${a}game/sprites/enemies/ovape.png`,{frameWidth:16,frameHeight:16}),this.load.spritesheet("pass",`${a}game/sprites/enemies/pass.png`,{frameWidth:16,frameHeight:16}),this.load.spritesheet("pontan",`${a}game/sprites/enemies/pontan.png`,{frameWidth:16,frameHeight:16}),this.load.spritesheet("explosion-center",`${a}game/sprites/bomb/explosion/explosion-center.png`,{frameWidth:18,frameHeight:18}),this.load.spritesheet("explosion-upper-lenght",`${a}game/sprites/bomb/explosion/explosion-upper-lenght.png`,{frameWidth:18,frameHeight:16}),this.load.spritesheet("explosion-lower-lenght",`${a}game/sprites/bomb/explosion/explosion-lower-lenght.png`,{frameWidth:18,frameHeight:16}),this.load.spritesheet("explosion-right-lenght",`${a}game/sprites/bomb/explosion/explosion-right-lenght.png`,{frameWidth:18,frameHeight:16}),this.load.spritesheet("explosion-left-lenght",`${a}game/sprites/bomb/explosion/explosion-left-lenght.png`,{frameWidth:18,frameHeight:16}),this.load.spritesheet("explosion-extension-horizontal",`${a}game/sprites/bomb/explosion/explosion-extension-horizontal.png`,{frameWidth:18,frameHeight:16}),this.load.spritesheet("explosion-extension-vertical",`${a}game/sprites/bomb/explosion/explosion-extension-vertical.png`,{frameWidth:18,frameHeight:16}),this.load.spritesheet("destroy-enemy",`${a}game/sprites/enemies/destroy-enemy/destroy-enemy.png`,{frameWidth:14,frameHeight:16}),this.load.audio("stage-theme",`${a}game/music/stage/stage-theme.mp3`),this.load.audio("bonus-theme",`${a}game/music/stage/bonus-theme.mp3`),this.load.audio("level-start",`${a}game/music/stage/level-start.mp3`),this.load.audio("level-complete",`${a}game/music/stage/level-complete.mp3`),this.load.audio("just-died",`${a}game/music/character/just-died.mp3`),this.load.audio("explosion",`${a}game/music/bomb/explosion.mp3`),this.load.audio("find-the-door",`${a}game/music/character/find_the_door.mp3`),this.load.audio("game-over",`${a}game/music/stage/game-over.mp3`),this.load.audio("menu-audio",`${a}game/music/stage/title-screen.mp3`),this.load.audio("walking-y",`${a}game/music/character/walk.mp3`),this.load.audio("walking-x",`${a}game/music/character/walk-2.mp3`),this.load.audio("put-bomb",`${a}game/music/bomb/put-bomb.wav`),this.load.audio("power-up",`${a}game/music/character/power-up.wav`),this.load.audio("lose",`${a}game/music/character/lose.wav`),this.load.audio("last-enemy",`${a}game/music/enemy/last-enemy.wav`)}create(){this.scene.start("MainMenu")}}var r=(e=>(e[e.ONE=0]="ONE",e[e.TWO=1]="TWO",e[e.THREE=2]="THREE",e[e.FOUR=3]="FOUR",e[e.FIVE=4]="FIVE",e[e.FINAL_BONUS=5]="FINAL_BONUS",e))(r||{}),n=(e=>(e[e.START=0]="START",e[e.RESTART=1]="RESTART",e[e.LOADED_GAME=2]="LOADED_GAME",e[e.GAME_OVER=3]="GAME_OVER",e[e.NEXT_STAGE=4]="NEXT_STAGE",e[e.COMPLETED=5]="COMPLETED",e))(n||{});const l=()=>({stage:r.ONE,lives:5,time:200,status:n.START,totalScore:0,stageScore:0,powerUps:[]});class h{constructor(e){t(this,"_saveGameControl"),this._setUpControls(e)}_setUpControls(e){e.input.keyboard&&(this._saveGameControl=e.input.keyboard.addKey(s.Input.Keyboard.KeyCodes.S))}get saveGameControl(){return this._saveGameControl}}var d=(e=>(e.HIGHEST_SCORE_KEY="_bombermanJS_highest_score",e.SAVED_GAME="_bombermanJS_saved_game",e))(d||{});class m{constructor({scene:e,gameStage:s,player:i,enemiesGroup:a,mapManager:o}){t(this,"_scene"),t(this,"_gameStage"),t(this,"_player"),t(this,"_enemiesGroup"),t(this,"_mapManager"),t(this,"_controlsManager"),this._scene=e,this._gameStage=s,this._player=i,this._enemiesGroup=a,this._mapManager=o,this._controlsManager=new h(e)}static getLoadedGame(){const e=localStorage.getItem(d.SAVED_GAME);return e?JSON.parse(e):null}addControlsListener(){var e,t,s;if((null==(e=this._player.body)?void 0:e.enable)&&(null==(s=null==(t=this._controlsManager)?void 0:t.saveGameControl)?void 0:s.isDown)){const e=this._scene.add.text(850,22,"SAVING GAME ...").setFontFamily('"BitBold", "Tahoma"').setFontSize(15).setColor("white").setStroke("black",2.5).setScrollFactor(0,0);this._scene.time.addEvent({delay:2e3,callback:()=>e.destroy(!0),callbackScope:this}),this._saveGame()}}_saveGame(){const e={...this._gameStage};e.status=n.LOADED_GAME;const t={gameStage:e,player:this._player.getSavedState(),enemies:this._enemiesGroup.getSavedState(),map:this._mapManager.getSavedState()};localStorage.setItem(d.SAVED_GAME,JSON.stringify(t))}}class c extends s.Scene{constructor(){super("MainMenu")}create(){this.cameras.main.backgroundColor=Phaser.Display.Color.HexStringToColor("#000000");const e=this.cameras.main.width<768,t=this.cameras.main.centerX,i=this.cameras.main.centerY,a=e?1.2:2.4,o=e?16:20,r=e?17:21,n=e?80:230,h=i+(e?80:120),c=e?10:12,p=e?160:220;this.add.sprite(t,i-(e?40:80),"menu-title").setScale(a);const _=this.add.text(t-n/2,h,"START").setFontFamily('"BitBold", "Tahoma"').setFontSize(o).setColor("white").setStroke("black",2.5).setInteractive({useHandCursor:!0}).on(Phaser.Input.Events.POINTER_OVER,(()=>{_.setFontSize(r).setColor("#bdbd16")}),this).on(Phaser.Input.Events.POINTER_OUT,(()=>{_.setFontSize(o).setColor("white")}),this).on(Phaser.Input.Events.POINTER_DOWN,(()=>{this.sound.stopAll();const e=l();this.scene.start("ChangeStage",e)}),this),y=this.add.text(t+n/2,h,"CONTINUE").setFontFamily('"BitBold", "Tahoma"').setFontSize(o).setColor("white").setStroke("black",2.5).setInteractive({useHandCursor:!0}).on(Phaser.Input.Events.POINTER_OVER,(()=>{y.setFontSize(r).setColor("#bdbd16")}),this).on(Phaser.Input.Events.POINTER_OUT,(()=>{y.setFontSize(o).setColor("white")}),this).on(Phaser.Input.Events.POINTER_DOWN,(()=>{const e=m.getLoadedGame();e&&this.scene.start("ChangeStage",e.gameStage)}),this),u=h+(e?25:30);this.add.text(t-n/2,u,"TOP").setFontFamily('"BitBold", "Tahoma"').setFontSize(o).setColor("white").setStroke("black",2.5);const g=localStorage.getItem(d.HIGHEST_SCORE_KEY)??0;this.add.text(t+n/2,u,g.toString()).setFontFamily('"BitBold", "Tahoma"').setFontSize(o).setColor("white").setStroke("black",2.5);const b=this.add.text(t,i+p,"This little game was born as an inspiration \n to learn about the awesome universe of the Web Game Development").setOrigin(.5).setAlign("center").setFontFamily('"BitBold", "Tahoma"').setFontSize(c).setColor("white").setStroke("black",2.5);e&&b.setWordWrapWidth(this.cameras.main.width-20),this.add.text(t,i+p+(e?20:30),`Phaser ${s.VERSION} ❤️`).setOrigin(.5).setFontFamily('"BitBold", "Tahoma"').setFontSize(c+1).setColor("#bdbd16").setStroke("#8e001c",2.5),this.sound.play("menu-audio",{loop:!0,volume:.5})}}class p extends s.Scene{constructor(){super("ChangeStage"),t(this,"_gameStage")}init(e){this._gameStage=e}create(){var e;if(this.sound.stopAll(),this.cameras.main.backgroundColor=Phaser.Display.Color.HexStringToColor("#000000"),this._gameStage)switch(null==(e=this._gameStage)?void 0:e.status){case n.START:this._gameStage=l(),this._prepareUI({text:this._getStageText(),delay:4,soundKey:"level-start",sceneKey:"Game"});break;case n.RESTART:const e=this._gameStage.lives,t=this._gameStage.stage,s=this._gameStage.totalScore;this._gameStage=l(),this._gameStage.lives=e,this._gameStage.stage=t,this._gameStage.totalScore=s,this._prepareUI({text:this._getStageText(),delay:4,soundKey:"level-start",sceneKey:"Game"});break;case n.LOADED_GAME:this._prepareUI({text:this._getStageText(),delay:4,soundKey:"level-start",sceneKey:"Game"});break;case n.GAME_OVER:localStorage.clear(),this._prepareUI({text:"GAME OVER",delay:7,soundKey:"game-over",sceneKey:"MainMenu"});break;case n.NEXT_STAGE:this._gameStage.stage++,this._prepareUI({text:this._getStageText(),delay:4,soundKey:"level-start",sceneKey:"Game"});break;case n.COMPLETED:localStorage.clear(),this._prepareUI({text:"Amazing! \n Thanks for playing!",delay:10,soundKey:"level-complete",sceneKey:"MainMenu"})}}_prepareUI(e){const{text:t,delay:s,soundKey:i}=e;this.add.text(this.cameras.main.centerX,this.cameras.main.centerY,t).setFontFamily('"BitBold", "Tahoma"').setFontSize(15).setColor("white").setStroke("black",2.5).setOrigin(.5).setAlign("center"),this.sound.play(i);const a=this.time.addEvent({delay:1e3,repeat:s,callback:()=>{const{repeatCount:t}=a;t<=0&&this.scene.start(e.sceneKey,this._gameStage)},callbackScope:this})}_getStageText(){var e,t;return(null==(e=this._gameStage)?void 0:e.stage)===r.FINAL_BONUS?"BONUS STAGE":`STAGE ${((null==(t=this._gameStage)?void 0:t.stage)??0)+1}`}}class _{constructor(e){t(this,"_cursorKeys"),t(this,"_putBombControl"),t(this,"_exploitBombControl"),t(this,"_touchControls"),this._touchControls={up:!1,down:!1,left:!1,right:!1,putBomb:!1,exploitBomb:!1},this._setUpControls(e),this._setUpTouchControls()}_setUpControls(e){e.input.keyboard&&(this._cursorKeys=e.input.keyboard.createCursorKeys(),this._putBombControl=e.input.keyboard.addKey(s.Input.Keyboard.KeyCodes.X),this._exploitBombControl=e.input.keyboard.addKey(s.Input.Keyboard.KeyCodes.SPACE))}_setUpTouchControls(){"undefined"!=typeof window&&(window.touchControlUp=e=>{this._touchControls.up=e},window.touchControlDown=e=>{this._touchControls.down=e},window.touchControlLeft=e=>{this._touchControls.left=e},window.touchControlRight=e=>{this._touchControls.right=e},window.touchControlPutBomb=e=>{this._touchControls.putBomb=e},window.touchControlExploitBomb=e=>{this._touchControls.exploitBomb=e})}get cursorKeys(){if(!this._cursorKeys){const e={up:{isDown:!1},down:{isDown:!1},left:{isDown:!1},right:{isDown:!1}};return Object.defineProperty(e.up,"isDown",{get:()=>this._touchControls.up}),Object.defineProperty(e.down,"isDown",{get:()=>this._touchControls.down}),Object.defineProperty(e.left,"isDown",{get:()=>this._touchControls.left}),Object.defineProperty(e.right,"isDown",{get:()=>this._touchControls.right}),e}const e={up:{...this._cursorKeys.up},down:{...this._cursorKeys.down},left:{...this._cursorKeys.left},right:{...this._cursorKeys.right}};return Object.defineProperty(e.up,"isDown",{get:()=>this._cursorKeys.up.isDown||this._touchControls.up}),Object.defineProperty(e.down,"isDown",{get:()=>this._cursorKeys.down.isDown||this._touchControls.down}),Object.defineProperty(e.left,"isDown",{get:()=>this._cursorKeys.left.isDown||this._touchControls.left}),Object.defineProperty(e.right,"isDown",{get:()=>this._cursorKeys.right.isDown||this._touchControls.right}),e}get putBombControl(){if(!this._putBombControl){const e={isDown:!1};return Object.defineProperty(e,"isDown",{get:()=>this._touchControls.putBomb}),e}const e={...this._putBombControl};return Object.defineProperty(e,"isDown",{get:()=>this._putBombControl.isDown||this._touchControls.putBomb}),e}get exploitBombControl(){if(!this._exploitBombControl){const e={isDown:!1};return Object.defineProperty(e,"isDown",{get:()=>this._touchControls.exploitBomb}),e}const e={...this._exploitBombControl};return Object.defineProperty(e,"isDown",{get:()=>this._exploitBombControl.isDown||this._touchControls.exploitBomb}),e}resetTouchControls(){this._touchControls.up=!1,this._touchControls.down=!1,this._touchControls.left=!1,this._touchControls.right=!1,this._touchControls.putBomb=!1,this._touchControls.exploitBomb=!1}}var y=(e=>(e.UP="up",e.LEFT="left",e.RIGH="right",e.DOWN="down",e.IDLE="idle",e))(y||{});class u extends s.Physics.Arcade.Sprite{constructor({scene:e,x:s,y:i,bombGroup:a,gameStage:o,savedGame:r}){super(e,s,i,"bomberman-move"),t(this,"_direction"),t(this,"_controlsManager"),t(this,"_speed"),t(this,"_hasWallPassPowerUp"),t(this,"_hasBombPassPowerUp"),t(this,"_hasFlamePassPowerUp"),t(this,"_lastTilePassedPosition"),t(this,"_savedGame"),t(this,"_bombGroup"),this._direction=y.LEFT,this._speed=150,this._hasWallPassPowerUp=!1,this._hasBombPassPowerUp=!1,this._hasFlamePassPowerUp=!1,this._lastTilePassedPosition={x:s,y:i},this._bombGroup=a,this._savedGame=r,e.add.existing(this),e.physics.add.existing(this),this.setScale(2),this.setBodySize(this.width-5,this.height),this._validateSavedPlayer(o),this._setUpControls(),this._setUpAnimations(),this.scene.cameras.main.startFollow(this,!0),this.scene.cameras.main.setFollowOffset(0,0),this.scene.cameras.main.setDeadzone(0,0)}_validateSavedPlayer(e){if(e.status===n.LOADED_GAME&&this._savedGame){const{player:e}=this._savedGame;this.setPosition(e.x,e.y)}}_setUpControls(){this._controlsManager=new _(this.scene)}_setUpAnimations(){this.anims.create({key:y.LEFT,frames:this.anims.generateFrameNumbers("bomberman-move",{frames:[0,1,2]}),frameRate:10,repeat:-1}),this.anims.create({key:y.RIGH,frames:this.anims.generateFrameNumbers("bomberman-move",{frames:[3,4,5]}),frameRate:10,repeat:-1}),this.anims.create({key:y.DOWN,frames:this.anims.generateFrameNumbers("bomberman-move",{frames:[6,7,8]}),frameRate:10,repeat:-1}),this.anims.create({key:y.UP,frames:this.anims.generateFrameNumbers("bomberman-move",{frames:[9,10,11]}),frameRate:10,repeat:-1}),this.anims.create({key:"die",frames:this.anims.generateFrameNumbers("bomberman-dead"),frameRate:8})}_playSoundByKey(e){let t=this.scene.sound.get(e);null===t&&(t=this.scene.sound.add(e)),t.isPlaying||t.play({volume:.4})}_playAnimationByKey(e,t){if(this._direction!=e)return this.play(e),void(this._direction=e);this.anims.isPlaying||this.anims.nextFrame(),this._playSoundByKey(t)}addControlsListener(){var e,t,s,i,a,o,r,n,l,h,d,m,c;if(null==(e=this.body)?void 0:e.enable){this.setVelocity(0);let e=!1;(null==(s=null==(t=this._controlsManager)?void 0:t.cursorKeys)?void 0:s.right.isDown)?(this.setVelocityX(this._speed),this._playAnimationByKey(y.RIGH,"walking-x"),e=!0):(null==(a=null==(i=this._controlsManager)?void 0:i.cursorKeys)?void 0:a.left.isDown)?(this.setVelocityX(-this._speed),this._playAnimationByKey(y.LEFT,"walking-x"),e=!0):(null==(r=null==(o=this._controlsManager)?void 0:o.cursorKeys)?void 0:r.up.isDown)?(this.setVelocityY(-this._speed),this._playAnimationByKey(y.UP,"walking-y"),e=!0):(null==(l=null==(n=this._controlsManager)?void 0:n.cursorKeys)?void 0:l.down.isDown)&&(this.setVelocityY(this._speed),this._playAnimationByKey(y.DOWN,"walking-y"),e=!0),(null==(d=null==(h=this._controlsManager)?void 0:h.putBombControl)?void 0:d.isDown)&&this._bombGroup.putBomb(this._lastTilePassedPosition.x,this._lastTilePassedPosition.y),(null==(c=null==(m=this._controlsManager)?void 0:m.exploitBombControl)?void 0:c.isDown)&&this._bombGroup.exploitNextBomb(),e||this._direction==y.IDLE||(this.stop(),this._direction=y.IDLE)}}kill(){this.setVelocity(0),this.disableBody(!1),this.setImmovable(!0),this.scene.game.sound.stopAll(),this.scene.sound.play("lose"),this.play({key:"die",hideOnComplete:!0}).on(s.Animations.Events.ANIMATION_COMPLETE,(()=>{this.scene.sound.play("just-died")}),this)}validateTileOverlap(e){if(e.body&&this.body){const t=Math.round(this.body.center.x),s=Math.round(this.body.center.y),i=Math.floor(e.body.center.x),a=Math.floor(e.body.center.y),o=Math.abs(t-i),r=Math.abs(s-a);return o<=10&&r<=10}return!1}getSavedState(){var e,t;return{x:(null==(e=this.body)?void 0:e.center.x)??0,y:(null==(t=this.body)?void 0:t.center.y)??0}}get speed(){return this._speed}set speed(e){this._speed=e}get hasWallPassPowerUp(){return this._hasWallPassPowerUp}set hasWallPassPowerUp(e){this._hasWallPassPowerUp=e}get hasBombPassPowerUp(){return this._hasBombPassPowerUp}set hasBombPassPowerUp(e){this._hasBombPassPowerUp=e}get hasFlamePassPowerUp(){return this._hasFlamePassPowerUp}set hasFlamePassPowerUp(e){this._hasFlamePassPowerUp=e}get lastTilePassedPosition(){return this._lastTilePassedPosition}set lastTilePassedPosition(e){this._lastTilePassedPosition=e}}class g extends s.Physics.Arcade.Sprite{constructor({scene:e,x:t,y:s}){super(e,t,s,"bomb"),this.setScale(1.8),this._setUpAnimations(),this.play("wait")}_setUpAnimations(){this.anims.create({key:"wait",frames:this.anims.generateFrameNumbers("bomb"),frameRate:3,repeat:-1})}}class b extends s.Physics.Arcade.Sprite{constructor({scene:e,x:t,y:i,textureKey:a,isVisible:o}){super(e,t,i,a),e.physics.add.existing(this),this.setScale(2.4),this.setVisible(o),this.setImmovable(!0),this.setBodySize(this.width-5,this.height-5),this.play(a).once(s.Animations.Events.ANIMATION_COMPLETE,(()=>{this.destroy(!0)}))}}class x extends s.Physics.Arcade.Group{constructor({world:e,scene:s,wallBuilderManager:i}){super(e,s),t(this,"_explosionLength"),t(this,"_explosionProperties"),t(this,"_wallBuilderManager"),this.classType=b,this._explosionLength=0,this._explosionProperties=[{spriteXOffset:0,spriteYOffset:0,tileXOffset:0,tileYOffset:0,textureKey:"explosion-center"},{spriteXOffset:0,spriteYOffset:-33,tileXOffset:0,tileYOffset:-40,textureKey:"explosion-upper-lenght",textureKeyExtension:"explosion-extension-vertical"},{spriteXOffset:0,spriteYOffset:33,tileXOffset:0,tileYOffset:40,textureKey:"explosion-lower-lenght",textureKeyExtension:"explosion-extension-vertical"},{spriteXOffset:33,spriteYOffset:0,tileXOffset:40,tileYOffset:0,textureKey:"explosion-right-lenght",textureKeyExtension:"explosion-extension-horizontal"},{spriteXOffset:-33,spriteYOffset:0,tileXOffset:-40,tileYOffset:0,textureKey:"explosion-left-lenght",textureKeyExtension:"explosion-extension-horizontal"}],this._wallBuilderManager=i,this._setUpAnimations()}_setUpAnimations(){for(const t of this._explosionProperties){const e=this.scene.anims.generateFrameNumbers(t.textureKey);this._createAnimationByData(t.textureKey,e)}const e=new Set(this._explosionProperties.filter((e=>void 0!==e.textureKeyExtension)).map((e=>e.textureKeyExtension??"")));for(const t of e){const e=this.scene.anims.generateFrameNumbers(t);this._createAnimationByData(t,e)}}_createAnimationByData(e,t){this.scene.anims.exists(e)||this.scene.anims.create({key:e,frames:t,frameRate:12,yoyo:!0})}addNewExplosion(e,t){for(const s of this._explosionProperties){const i={spriteX:e+s.spriteXOffset,spriteY:t+s.spriteYOffset,tileX:e+s.tileXOffset,tileY:t+s.tileYOffset};if(this._addExplosionExtension(i,s)){const e=0===s.tileXOffset&&0===s.tileYOffset;this._addExplosionSprite(i,s.textureKey,e)}}this.scene.sound.play("explosion")}_addExplosionExtension(e,t){if(t.textureKeyExtension)for(let s=0;s<this._explosionLength;s++){if(!this._addExplosionSprite(e,t.textureKeyExtension,!1))return!1;e.spriteX+=t.spriteXOffset,e.spriteY+=t.spriteYOffset,e.tileX+=t.tileXOffset,e.tileY+=t.tileYOffset}return!0}_addExplosionSprite(e,t,s){let i=this._isBusyPosition(e);s&&(i=!1);const a=new b({scene:this.scene,x:e.spriteX,y:e.spriteY,textureKey:t,isVisible:!i});return this.add(a,!0),!i}_isBusyPosition(e){return!this._wallBuilderManager.isPositionFree(e.tileX,e.tileY)}get explosionLength(){return this._explosionLength}set explosionLength(e){this._explosionLength=e}}var w=(e=>(e[e.GAME=0]="GAME",e[e.PUT_BOMB=1]="PUT_BOMB",e[e.EXPLOIT_BOMB=2]="EXPLOIT_BOMB",e))(w||{});class S extends s.Physics.Arcade.StaticGroup{constructor({world:e,scene:s,wallBuilderManager:i}){super(e,s),t(this,"_timers"),t(this,"_maxAmountBombs"),t(this,"_isActiveRemoteControl"),t(this,"_timePutBomb"),t(this,"_timeExplosion"),t(this,"_explosionGroup"),t(this,"_wallBuilderManager"),this.classType=g,this._timers=new Map,this._maxAmountBombs=1,this._isActiveRemoteControl=!1,this._timePutBomb=0,this._timeExplosion=2,this._explosionGroup=new x({world:this.world,scene:this.scene,wallBuilderManager:i}),this._wallBuilderManager=i}putBomb(e,t){if(this._canPutBomb(e,t)){this.scene.sound.play("put-bomb");const s=new g({scene:this.scene,x:e,y:t});this.add(s,!0),this._wallBuilderManager.deletePositionFree(e,t),this.isActiveRemoteControl||this._setExplodeBombTimer(s),this._setPutBombTimer()}}exploitByBomb(e){this._exploitBomb(e)}exploitNextBomb(){if(this._canExploitBomb()){const e=this.getFirstAlive();this._exploitBomb(e)}}_exploitBomb(e){if(e.body){const t=Math.floor(e.body.center.x),s=Math.floor(e.body.center.y),i=new Phaser.Time.TimerEvent({delay:400,callback:()=>{this._wallBuilderManager.addPositionFree(t,s)},callbackScope:this});this.scene.time.addEvent(i),this._explosionGroup.addNewExplosion(t,s),e.destroy(!0)}}_setPutBombTimer(){const e=new Phaser.Time.TimerEvent({delay:1e3,repeat:this._timePutBomb,callbackScope:this});this.scene.time.addEvent(e),this._timers.set(w.PUT_BOMB,e)}_setExplodeBombTimer(e){const t=new Phaser.Time.TimerEvent({delay:1e3,repeat:this._timeExplosion,callback:()=>{const{repeatCount:s}=t;s<=0&&this._exploitBomb(e)},callbackScope:this});this.scene.time.addEvent(t)}_canPutBomb(e,t){const s=this._timers.get(w.PUT_BOMB);return!!this._wallBuilderManager.isPositionFree(e,t)&&(void 0===s||0===(null==s?void 0:s.repeatCount))&&this.getTotalUsed()<this._maxAmountBombs}_canExploitBomb(){return this._isActiveRemoteControl&&this.getTotalUsed()>0}get explosionGroup(){return this._explosionGroup}get maxAmountBombs(){return this._maxAmountBombs}set maxAmountBombs(e){this._maxAmountBombs=e}get isActiveRemoteControl(){return this._isActiveRemoteControl}set isActiveRemoteControl(e){this._isActiveRemoteControl=e}}var f=(e=>(e[e.UP=0]="UP",e[e.LEFT=1]="LEFT",e[e.RIGHT=2]="RIGHT",e[e.DOWN=3]="DOWN",e))(f||{});class v{constructor(e,s){t(this,"_player"),t(this,"_enemyBody"),t(this,"_direction"),t(this,"_directions"),t(this,"_retracedMotions"),t(this,"_MAX_RETRACED_MOTIONS"),this._player=e,this._enemyBody=s,this._direction=f.LEFT,this._directions=[f.LEFT,f.RIGHT,f.UP,f.DOWN],this._retracedMotions=0,this._MAX_RETRACED_MOTIONS=5}computeNewDirection(){throw new Error("Method not implemented.")}_getOppositeDirection(e){switch(e){case f.LEFT:return f.RIGHT;case f.RIGHT:return f.LEFT;case f.UP:return f.DOWN;case f.DOWN:return f.UP;default:throw new Error("Direction type is invalid")}}_getRndDirectionByExclusion(e){const t=this._directions.filter((t=>t!==e));return t[Phaser.Math.RND.between(0,t.length-1)]}retraceMotion(){const e=this._getOppositeDirection(this._direction);if(this._retracedMotions>=this._MAX_RETRACED_MOTIONS)return this._direction=this._getRndDirectionByExclusion(e),void(this._retracedMotions=0);void 0!==e&&(this._direction=e,this._retracedMotions++)}validateCrossroadOverlap(e,t){var s,i,a,o;if(0===(null==(s=this._enemyBody)?void 0:s.velocity.x)&&0===(null==(i=this._enemyBody)?void 0:i.velocity.y))return!1;const r={x:e.x??0,y:e.y??0};if(t&&t.x===(null==r?void 0:r.x)&&t.y===(null==r?void 0:r.y))return!1;const n={x:(null==(a=this._enemyBody)?void 0:a.center.x)??0,y:(null==(o=this._enemyBody)?void 0:o.center.y)??0},l=Math.round(n.x),h=Math.round(n.y),d=Math.floor(t.x),m=Math.floor(t.y),c=Math.abs(l-d),p=Math.abs(h-m);return c<=5&&p<=5}get direction(){return this._direction}set direction(e){this._direction=e}get directions(){return this._directions}get retracedMotions(){return this._retracedMotions}set retracedMotions(e){this._retracedMotions=e}get player(){return this._player}get enemyBody(){return this._enemyBody}}class E extends v{constructor(e,t){super(e,t)}computeNewDirection(){this.retracedMotions=0;const e=Phaser.Math.RND.between(0,this.directions.length-1);this.direction=this.directions[e]}}class P extends v{constructor(e,t){super(e,t)}computeNewDirection(){if(this.enemyBody&&this.player.body){this.retracedMotions=0;const e=Math.round(this.player.body.center.x),t=Math.round(this.player.body.center.y),s=e-Math.round(this.enemyBody.center.x),i=t-Math.round(this.enemyBody.center.y);if(Math.abs(s)>Math.abs(i))return void(this.direction=s>0?f.RIGHT:f.LEFT);if(Math.abs(i)>Math.abs(s))return void(this.direction=i>0?f.DOWN:f.UP);0!==s&&(this.direction=s>0?f.RIGHT:f.LEFT),0!==i&&(this.direction=i>0?f.DOWN:f.UP)}}}var M=(e=>(e[e.FIRST_LEVEL=0]="FIRST_LEVEL",e[e.SECOND_LEVEL=1]="SECOND_LEVEL",e))(M||{});class T{static getInstance({type:e,player:t,enemyBody:s}){switch(e){case M.FIRST_LEVEL:return new E(t,s);case M.SECOND_LEVEL:return new P(t,s)}}}class O extends s.Physics.Arcade.Sprite{constructor({scene:e,x:s,y:i,enemyData:a,hasTemporalShield:o,player:r}){super(e,s,i,a.textureKey),t(this,"_enemyData"),t(this,"_player"),t(this,"_animLeftKey"),t(this,"_animRightKey"),t(this,"_animDeadKey"),t(this,"_hasTemporalShield"),t(this,"_mapCrossroadOffset"),t(this,"_lastCrossroadTouched"),t(this,"_motionManager"),e.physics.add.existing(this),this._enemyData=a,this._player=r,this._animLeftKey=`${this._enemyData.type}-left`,this._animRightKey=`${this._enemyData.type}-right`,this._animDeadKey=`${this._enemyData.type}-dead`,this._hasTemporalShield=o,this._mapCrossroadOffset=50,this._lastCrossroadTouched={x:s,y:i},this.setScale(2),this._setUpTemporalShield()}_setUpTemporalShield(){if(this._hasTemporalShield){const e=new Phaser.Time.TimerEvent({delay:100,repeat:40,callback:()=>{const{repeatCount:t}=e;this.setVisible(!this.visible),t<=0&&(this.setVisible(!0),this._hasTemporalShield=!1)},callbackScope:this});this.scene.time.addEvent(e)}}_updateSpriteMotion(e){var t,s;if(null==(t=this.body)?void 0:t.enable)switch(null==(s=this._motionManager)?void 0:s.direction){case f.LEFT:this.play(this._animLeftKey),this.scene.physics.moveTo(this,e.x-this._mapCrossroadOffset,e.y,this._enemyData.velocity);break;case f.RIGHT:this.play(this._animRightKey),this.scene.physics.moveTo(this,e.x+this._mapCrossroadOffset,e.y,this._enemyData.velocity);break;case f.DOWN:this.play(this._animLeftKey),this.scene.physics.moveTo(this,e.x,e.y+this._mapCrossroadOffset,this._enemyData.velocity);break;case f.UP:this.play(this._animRightKey),this.scene.physics.moveTo(this,e.x,e.y-this._mapCrossroadOffset,this._enemyData.velocity)}}setMotionManager(e){this._motionManager=T.getInstance({type:e,player:this._player,enemyBody:this.body})}dispatchMotion(){var e;this.setVelocity(0),this._lastCrossroadTouched&&(this.setPosition(this._lastCrossroadTouched.x,this._lastCrossroadTouched.y),null==(e=this._motionManager)||e.computeNewDirection(),this._updateSpriteMotion({x:this._lastCrossroadTouched.x,y:this._lastCrossroadTouched.y}))}retraceMotion(){var e,t,s;this.setVelocity(0),this.body&&(null==(e=this._motionManager)||e.retraceMotion(),this._updateSpriteMotion({x:null==(t=this.body)?void 0:t.center.x,y:null==(s=this.body)?void 0:s.center.y}))}validateCrossroadOverlap(e){var t,s;return!(!this._motionManager||!this._lastCrossroadTouched)&&this._motionManager.validateCrossroadOverlap({x:null==(t=this._lastCrossroadTouched)?void 0:t.x,y:null==(s=this._lastCrossroadTouched)?void 0:s.y},e)}kill(){this.disableBody(!1),this.setImmovable(!0),this.play(this._animDeadKey).once(s.Animations.Events.ANIMATION_COMPLETE,(()=>{this.play("destroy-enemy").once(s.Animations.Events.ANIMATION_COMPLETE,(()=>{var e,t;if(this.body){const s=this.scene.add.text(null==(e=this.body)?void 0:e.center.x,null==(t=this.body)?void 0:t.center.y,this.enemyData.rewardPoints.toString()).setFontFamily('"BitBold", "Tahoma"').setFontSize(10).setColor("white").setStroke("black",2.5);this.scene.time.addEvent({delay:2e3,callback:()=>s.destroy(!0),callbackScope:this})}this.destroy(!0)}))}))}get enemyData(){return this._enemyData}get lastCrossroadTouched(){return this._lastCrossroadTouched}set lastCrossroadTouched(e){this._lastCrossroadTouched=e}get hasTemporalShield(){return this._hasTemporalShield}}var B=(e=>(e.BALLOM="ballom",e.ONIL="onil",e.MINVO="minvo",e.DAHL="dahl",e.OVAPE="ovape",e.PONTAN="pontan",e.PASS="pass",e))(B||{}),A=(e=>(e[e.BOMB_UP=0]="BOMB_UP",e[e.FIRE_UP=1]="FIRE_UP",e[e.SPEED_UP=2]="SPEED_UP",e[e.REMOTE_CONTROL=3]="REMOTE_CONTROL",e[e.WALL_PASS=4]="WALL_PASS",e[e.BOMB_PASS=5]="BOMB_PASS",e[e.FLAME_PASS=6]="FLAME_PASS",e))(A||{});const L=()=>[{stage:r.ONE,powerUp:A.BOMB_UP,enemies:[{quantity:4,type:B.BALLOM}]},{stage:r.TWO,powerUp:A.FIRE_UP,enemies:[{quantity:2,type:B.BALLOM},{quantity:3,type:B.ONIL}]},{stage:r.THREE,powerUp:A.REMOTE_CONTROL,enemies:[{quantity:2,type:B.BALLOM},{quantity:3,type:B.ONIL},{quantity:1,type:B.DAHL}]},{stage:r.FOUR,powerUp:A.SPEED_UP,enemies:[{quantity:2,type:B.BALLOM},{quantity:3,type:B.DAHL},{quantity:2,type:B.MINVO}]},{stage:r.FIVE,powerUp:A.FLAME_PASS,enemies:[{quantity:4,type:B.MINVO},{quantity:3,type:B.OVAPE},{quantity:1,type:B.PASS}]},{stage:r.FINAL_BONUS,enemies:[{quantity:10,type:B.PONTAN}]}];class C extends s.Physics.Arcade.Group{constructor({world:e,scene:s,wallBuilderManager:i,player:a,savedGame:o,gameStage:r}){super(e,s),t(this,"_enemyLevel"),t(this,"_wallBuilderManager"),t(this,"_player"),t(this,"_savedGame"),t(this,"_gameStage"),this._enemyLevel=this._getEnemyLevelByKey(r.stage),this._wallBuilderManager=i,this._player=a,this._gameStage=r,this._savedGame=o,this.classType=O,this._setUp()}_getEnemyLevelByKey(e){const t=L(),s=t.find((t=>t.stage===e));return void 0===s?t[0].enemies:s.enemies}_getEnemyDataByKey(e){const t=[{type:B.BALLOM,textureKey:"ballom",velocity:30,hasWallPassPowerUp:!1,rewardPoints:100,motionEnemyType:M.FIRST_LEVEL},{type:B.ONIL,textureKey:"onil",velocity:65,hasWallPassPowerUp:!1,rewardPoints:150,motionEnemyType:M.FIRST_LEVEL},{type:B.MINVO,textureKey:"minvo",velocity:100,hasWallPassPowerUp:!1,rewardPoints:200,motionEnemyType:M.FIRST_LEVEL},{type:B.DAHL,textureKey:"dahl",velocity:70,hasWallPassPowerUp:!1,rewardPoints:250,motionEnemyType:M.FIRST_LEVEL},{type:B.OVAPE,textureKey:"ovape",velocity:50,hasWallPassPowerUp:!0,rewardPoints:300,motionEnemyType:M.FIRST_LEVEL},{type:B.PASS,textureKey:"pass",velocity:95,hasWallPassPowerUp:!1,rewardPoints:350,motionEnemyType:M.FIRST_LEVEL},{type:B.PONTAN,textureKey:"pontan",velocity:120,hasWallPassPowerUp:!0,rewardPoints:400,motionEnemyType:M.SECOND_LEVEL}],s=t.find((t=>t.type===e));return void 0===s?t[0]:s}_setUp(){this._gameStage.status===n.LOADED_GAME&&this._savedGame?this._createEnemiesFromData(this._savedGame.enemies):this._createEnemies(),this._setUpAnimations()}_createEnemies(){for(const e of this._enemyLevel){const t=this._getEnemyDataByKey(e.type);this._createAnimationByEnemy(t);for(let s=0;s<e.quantity;s++){const{element:e}=this._wallBuilderManager.pickSafeRndFreePosition();this._createNewEnemy(e,t,!1)}}}_createEnemiesFromData(e){for(const t of e){const e=this._getEnemyDataByKey(t.enemyData.type);this._createAnimationByEnemy(e);const{x:s,y:i}=t;this._createNewEnemy({x:s,y:i},e,!1)}}_setUpAnimations(){if(void 0===this._enemyLevel.find((e=>e.type===B.PONTAN))){const e=this._getEnemyDataByKey(B.PONTAN);this._createAnimationByEnemy(e)}this.scene.anims.exists("destroy-enemy")||this.scene.anims.create({key:"destroy-enemy",frames:this.scene.anims.generateFrameNumbers("destroy-enemy"),frameRate:3,delay:2e3})}_createAnimationByEnemy(e){const{type:t}=e,s=t===B.PONTAN?[0,1,2,3,4]:[0,1,2],i=t===B.PONTAN?[7,8,9,10,11]:[4,5,6],a=t===B.PONTAN?[Phaser.Math.RND.between(5,6)]:[3];this.scene.anims.exists(`${t}-left`)||this.scene.anims.create({key:`${t}-left`,frames:this.scene.anims.generateFrameNumbers(e.textureKey,{frames:s}),frameRate:6,repeat:-1}),this.scene.anims.exists(`${t}-right`)||this.scene.anims.create({key:`${t}-right`,frames:this.scene.anims.generateFrameNumbers(e.textureKey,{frames:i}),frameRate:6,repeat:-1}),this.scene.anims.exists(`${t}-dead`)||this.scene.anims.create({key:`${t}-dead`,frames:this.scene.anims.generateFrameNumbers(e.textureKey,{frames:a}),frameRate:6})}_createNewEnemy(e,t,s){const i=new O({scene:this.scene,x:e.x,y:e.y,enemyData:t,hasTemporalShield:s,player:this._player});this.add(i,!0),i.setMotionManager(t.motionEnemyType),i.dispatchMotion()}_getEnemiesPosition(){const e=[];if(this.getTotalUsed()>0)return this.getChildren().forEach((t=>{var s,i;const a=t;a.setImmovable(!0),e.push({x:Math.floor((null==(s=a.body)?void 0:s.center.x)??0),y:Math.floor((null==(i=a.body)?void 0:i.center.y)??0)})})),e;for(let t=0;t<7;t++){const{element:t}=this._wallBuilderManager.pickSafeRndFreePosition();e.push({x:t.x,y:t.y})}return e}addRandomByPosition(e,t){const s=Phaser.Math.RND.between(3,6),i=this._enemyLevel[this._enemyLevel.length-1],a=this._getEnemyDataByKey(i.type);for(let o=0;o<s;o++)this._createNewEnemy({x:e,y:t},a,!0)}replaceAllByType(e){const t=this._getEnemyDataByKey(e);this.clear(!0,!0);const s=this._getEnemiesPosition();for(const i of s)this._createNewEnemy(i,t,!1)}getSavedState(){return this.getChildren().map((e=>{var t,s;const i=e;return{x:Math.round((null==(t=i.body)?void 0:t.center.x)??0),y:Math.round((null==(s=i.body)?void 0:s.center.y)??0),enemyData:i.enemyData}}))}}class U{constructor({scene:e,gameStage:s,player:i,enemiesGroup:a}){t(this,"_scene"),t(this,"_gameStage"),t(this,"_player"),t(this,"_enemiesGroup"),t(this,"_labels"),t(this,"_timers"),this._scene=e,this._gameStage=s,this._player=i,this._enemiesGroup=a,this._labels=this._scene.add.group(),this._timers=new Map,this._setUp()}_setUp(){const e=this._scene.cameras.main.width,t=e<768,s=t?12:15,i={font:`${s}px BitBold`,fill:"white",stroke:"black",strokeThickness:2.5},a=t?Math.max(8,.02*e):22,o=t?Math.max(8,.02*e):22,r=t?Math.min(120,.35*e):170,n=t?Math.min(100,.28*e):128;let l=a;const h=this._scene.add.text(l,o,`TIME ${this._gameStage.time}`,i);h.setScrollFactor(0,0),h.setDepth(1e3),h.name="TIME",this._labels.add(h),l+=r;const d=this._scene.add.text(l,o,this._gameStage.stageScore.toString(),i);d.setScrollFactor(0,0),d.setDepth(1e3),d.name="SCORE",this._labels.add(d),l+=n;const m=t?80:100,c=e-m-(t?8:10);l>c&&(l=c);const p=this._scene.add.text(l,o,`LEFT ${this._gameStage.lives}`,i);p.setScrollFactor(0,0),p.setDepth(1e3),p.name="LEFT",this._labels.add(p);const _=this._scene.add.text(l+m+(t?8:12),o,"v2.0.2",{font:s-2+"px BitBold",stroke:"black",strokeThickness:1.5});_.setScrollFactor(0,0),_.setDepth(1e3),_.name="VERSION";const y=new Phaser.Time.TimerEvent({delay:1e3,repeat:this._gameStage.time,callback:()=>{const{repeatCount:e}=y;e<=0&&this._enemiesGroup.replaceAllByType(B.PONTAN),this._gameStage.time=e,this._setLabelTextByKey("TIME",`TIME ${e}`)},callbackScope:this});this._scene.time.addEvent(y),this._timers.set(w.GAME,y)}win(){this._scene.game.sound.stopAll(),(localStorage.getItem(d.HIGHEST_SCORE_KEY)??0)<localStorage.stage_points&&localStorage.setItem(d.HIGHEST_SCORE_KEY,localStorage.stage_points),this._player.disableBody(!1),this._player.setImmovable(!0),this._gameStage.stageScore+=450,this._gameStage.totalScore=this._gameStage.stageScore,this._gameStage.status=n.NEXT_STAGE,this._setLabelTextByKey("SCORE",this._gameStage.stageScore.toString()),this._scene.sound.play("level-complete");const e=new Phaser.Time.TimerEvent({delay:1e3,repeat:5,callback:()=>{const{repeatCount:t}=e;t<=0&&(this._gameStage.stage===r.FINAL_BONUS&&(this._gameStage.status=n.COMPLETED),this._scene.scene.start("ChangeStage",this._gameStage))},callbackScope:this});this._scene.time.addEvent(e)}lose(){const e=this._timers.get(w.GAME);e&&(e.paused=!0),this._gameStage.stageScore=0,this._player.kill(),this._gameStage.lives--,this._setLabelTextByKey("LEFT",`LEFT ${this._gameStage.lives}`);const t=new Phaser.Time.TimerEvent({delay:1e3,repeat:4,callback:()=>{const{repeatCount:e}=t;e<=0&&(this._gameStage.lives>=0?this._gameStage.status=n.RESTART:this._gameStage.status=n.GAME_OVER,this._scene.scene.start("ChangeStage",this._gameStage))},callbackScope:this});this._scene.time.addEvent(t)}_setLabelTextByKey(e,t){const s=this._labels.getMatching("name",e)[0];s&&s.setText(t)}get score(){return this._gameStage.stageScore}set score(e){this._gameStage.stageScore=e,this._setLabelTextByKey("SCORE",this._gameStage.stageScore.toString())}}class D extends s.Physics.Arcade.Sprite{constructor({scene:e,x:t,y:s}){super(e,t,s,"wall",0),this.setScale(2.5)}kill(){var e;(null==(e=this.body)?void 0:e.enable)&&(this.disableBody(!1),this.play("wall-explosion").once(s.Animations.Events.ANIMATION_COMPLETE,(()=>{this.destroy(!0)})))}}class G extends s.Physics.Arcade.StaticGroup{constructor({world:e,scene:t}){super(e,t),this.classType=D,this._setUpAnimations()}_setUpAnimations(){this.scene.anims.exists("wall-explosion")||this.scene.anims.create({key:"wall-explosion",frames:this.scene.anims.generateFrameNumbers("wall-explosion"),frameRate:12})}}var N=(e=>(e[e.ISOLATED=0]="ISOLATED",e[e.ROW=1]="ROW",e[e.COLUMN=2]="COLUMN",e))(N||{});class F{constructor({roads:e,crossroads:s,minWalls:i,maxWalls:a}){t(this,"_freePositions"),t(this,"_minWalls"),t(this,"_maxWalls"),t(this,"_wallTypes"),this._freePositions=[],this._minWalls=i,this._maxWalls=a,this._wallTypes=[N.ISOLATED,N.COLUMN,N.ROW],this._setUp(e,s)}_setUp(e,t){const s=[...e.map((e=>({x:e.x??0,y:e.y??0}))),...t.map((e=>({x:e.x??0,y:e.y??0})))];this._freePositions=s}_isIllegalPositions(e){return 60===e.x&&120===e.y||60===e.x&&160===e.y||100===e.x&&120===e.y}pickSafeRndFreePosition(){const e=Phaser.Math.RND.between(0,this._freePositions.length-1),t=this._freePositions[e];return this._isIllegalPositions(t)?this.pickSafeRndFreePosition():{element:t,index:e}}buildWallsFromArray(e,t){for(const s of e)t(s.x,s.y),this.deletePositionFree(s.x,s.y)}buildWalls(e){const t=Phaser.Math.RND.between(this._minWalls,this._maxWalls);let s=0;for(;s<t;){const t=Phaser.Math.RND.between(0,this._wallTypes.length-1),i=this._wallTypes[t],{element:a,index:o}=this.pickSafeRndFreePosition();switch(i){case N.ISOLATED:e(a.x,a.y),this._freePositions.splice(o,1),s++;break;case N.ROW:s+=this._allocateWallsInAxis({posWall:a,posWallsInAxis:this._freePositions.filter((e=>e.y===a.y)),addWallSpriteFn:e});break;case N.COLUMN:s+=this._allocateWallsInAxis({posWall:a,posWallsInAxis:this._freePositions.filter((e=>e.x===a.x)),addWallSpriteFn:e})}}}_allocateWallsInAxis(e){const{posWall:t,posWallsInAxis:s,addWallSpriteFn:i}=e;let a=Phaser.Math.RND.between(2,4);a>s.length&&(a=s.length);const o=s.findIndex((e=>e.x===t.x&&e.y===t.y));let r=a;for(let n=o;n<s.length&&r>0;n++)this._isIllegalPositions(s[n])||(i(s[n].x,s[n].y),this.deletePositionFree(s[n].x,s[n].y),r--);for(let n=o;n>=0&&r>0;n--)this._isIllegalPositions(s[n])||(i(s[n].x,s[n].y),this.deletePositionFree(s[n].x,s[n].y),r--);return a}isPositionFree(e,t){return this.freePositions.findIndex((s=>s.x===e&&s.y===t))>-1}addPositionFree(e,t){return this.freePositions.push({x:e,y:t})}deletePositionFree(e,t){const s=this.freePositions.findIndex((s=>s.x===e&&s.y===t));this._freePositions.splice(s,1)}get freePositions(){return this._freePositions}set freePositions(e){this._freePositions=e}}class R{constructor({scene:e,world:s,gameStage:i,savedGame:a}){t(this,"_scene"),t(this,"_world"),t(this,"_map"),t(this,"_mapLayer"),t(this,"_wallBuilderManager"),t(this,"_wallsGroup"),t(this,"_roads"),t(this,"_crossroads"),t(this,"_DEFAULT_MIN_WALLS"),t(this,"_DEFAULT_MAX_WALLS"),t(this,"_powerUp"),t(this,"_door"),t(this,"_savedGame"),t(this,"_gameStage"),this._scene=e,this._world=s,this._gameStage=i,this._savedGame=a,this._DEFAULT_MIN_WALLS=45,this._DEFAULT_MAX_WALLS=60,this._scene.cameras.main.backgroundColor=Phaser.Display.Color.HexStringToColor("#1F8B00"),this._createMap()}_createMap(){const e=this._createMapLayer();if(null===e)throw new Error("Map Layer is null to continue");this._map=e._map,this._mapLayer=e._mapLayer,this._setUpWalls(),this._setUpCrossroads(),this._setUpSpecialObjects(),this._setUpMusic(),this._scene.cameras.main.setBounds(0,0,this._map.widthInPixels,this._map.heightInPixels)}_createMapLayer(){const e=this._scene.add.tilemap("world"),t=e.addTilesetImage("tilemap");if(t){const s=e.createLayer("Map",t);if(s)return s.setCollisionByExclusion([-1]),{_map:e,_mapLayer:s}}return null}_setUpWalls(){var e,t;const s=(null==(e=this._map.objects.find((e=>"Roads"===e.name)))?void 0:e.objects)??[],i=(null==(t=this._map.objects.find((e=>"Crossroads"===e.name)))?void 0:t.objects)??[],{minWalls:a,maxWalls:o}=this._getAverageWalls();this._wallBuilderManager=new F({roads:s,crossroads:i,minWalls:a,maxWalls:o}),this._wallsGroup=new G({scene:this._scene,world:this._world}),this._validateSavedWalls(((e,t)=>{this._wallsGroup.add(new D({scene:this._scene,x:e,y:t}),!0)}))}_validateSavedWalls(e){this._gameStage.status===n.LOADED_GAME&&this._savedGame?this._wallBuilderManager.buildWallsFromArray(this._savedGame.map.walls,e):this._wallBuilderManager.buildWalls(e)}_getAverageWalls(){return this._gameStage.stage===r.FINAL_BONUS?{minWalls:0,maxWalls:0}:{minWalls:this._DEFAULT_MIN_WALLS,maxWalls:this._DEFAULT_MAX_WALLS}}_setUpCrossroads(){this._crossroads=this._setUpTileGroup("Crossroads"),this._roads=this._setUpTileGroup("Roads")}_setUpTileGroup(e){const t=this._scene.physics.add.group(),i=this._map.createFromObjects(e,{classType:s.Physics.Arcade.Image});return t.addMultiple(i).setVisible(!1).scaleXY(1.2,1.2)}_setUpSpecialObjects(){this._gameStage.stage!==r.FINAL_BONUS&&(this._setUpDoor(),this._setUpPowerUp())}_setUpDoor(){const e=this._getPositionByObject("door","hasDoor");this._door=this._scene.physics.add.image(e.x,e.y,"door").setScale(2.5).setVisible(this._getVisibilityByObject("door"))}_setUpPowerUp(){const e=this._getPowerUp(),t=this._getPositionByObject("powerUp","hasPowerUp");this._powerUp=this._scene.physics.add.image(t.x,t.y,e.textureKey).setScale(2.5).setData("powerUpId",e.id).setVisible(this._getVisibilityByObject("powerUp"))}_getPositionByObject(e,t){if(this._gameStage.status===n.LOADED_GAME&&this._savedGame){const s=this._savedGame.map[e];if(!s.isVisible){const e=this.wallsGroup.getChildren().find((e=>{var t,i;const a=e;return Math.floor((null==(t=a.body)?void 0:t.center.x)??0)===s.x&&Math.floor((null==(i=a.body)?void 0:i.center.y)??0)===s.y}));e&&e.setData(t,!0)}return{x:s.x,y:s.y}}const s=this._pickSafeRndWall();return s.setData(t,!0),{x:s.x,y:s.y}}_getVisibilityByObject(e){return!(this._gameStage.status!==n.LOADED_GAME||!this._savedGame)&&this._savedGame.map[e].isVisible}_getPowerUp(){const e=L(),t=[{id:A.BOMB_UP,textureKey:"bomb-up"},{id:A.FIRE_UP,textureKey:"fire-up"},{id:A.FLAME_PASS,textureKey:"flame-pass"},{id:A.REMOTE_CONTROL,textureKey:"remote-control"},{id:A.SPEED_UP,textureKey:"speed-up"},{id:A.WALL_PASS,textureKey:"wall-pass"}];let s=e.find((e=>e.stage===this._gameStage.stage));return void 0===s&&(s=e[0]),t.find((e=>e.id===s.powerUp))??t[0]}_pickSafeRndWall(){const e=Phaser.Math.RND.between(0,this.wallsGroup.getLength()-1),t=this.wallsGroup.getChildren()[e];return t.getData("hasPowerUp")||t.getData("hasDoor")?this._pickSafeRndWall():t}_setUpMusic(){const e=this._gameStage.stage===r.FINAL_BONUS?"bonus-theme":"stage-theme";this._scene.sound.play(e,{loop:!0,volume:.5})}getSavedState(){var e,t,s,i;return{walls:this.wallsGroup.getChildren().map((e=>{var t,s;const i=e;return{x:Math.round((null==(t=i.body)?void 0:t.center.x)??0),y:Math.round((null==(s=i.body)?void 0:s.center.y)??0)}})),door:{x:Math.round((null==(e=this.door.body)?void 0:e.center.x)??0),y:Math.round((null==(t=this.door.body)?void 0:t.center.y)??0),isVisible:this.door.visible},powerUp:{x:Math.round((null==(s=this.powerUp.body)?void 0:s.center.x)??0),y:Math.round((null==(i=this.powerUp.body)?void 0:i.center.y)??0),isVisible:this.powerUp.visible}}}get map(){return this._map}get mapLayer(){return this._mapLayer}get wallsGroup(){return this._wallsGroup}get crossroads(){return this._crossroads}get roads(){return this._roads}get wallBuilderManager(){return this._wallBuilderManager}get door(){return this._door}get powerUp(){return this._powerUp}}class I{constructor({scene:e,player:s,bombGroup:i,gameStage:a}){t(this,"_player"),t(this,"_bombGroup"),t(this,"_scene"),t(this,"_gameStage"),this._scene=e,this._player=s,this._bombGroup=i,this._gameStage=a,this._setUp()}_setUp(){for(const e of this._gameStage.powerUps)this._enablePowerUp(e)}addPowerUp(e){return this._scene.sound.stopByKey("stage-theme"),this._scene.sound.play("power-up"),this._scene.sound.play("find-the-door",{loop:!0}),this._gameStage.powerUps.push(e),this._enablePowerUp(e)}_enablePowerUp(e){switch(e){case A.BOMB_UP:return this._bombGroup.maxAmountBombs++,100;case A.FIRE_UP:return this._bombGroup.explosionGroup.explosionLength++,150;case A.SPEED_UP:return this._player.speed+=20,200;case A.REMOTE_CONTROL:return this._bombGroup.isActiveRemoteControl=!0,250;case A.WALL_PASS:return this._player.hasWallPassPowerUp=!0,300;case A.BOMB_PASS:return this._player.hasBombPassPowerUp=!0,350;case A.FLAME_PASS:return this._player.hasFlamePassPowerUp=!0,400;default:throw new Error("Power Up invalid")}}}class K extends s.Scene{constructor(){super("Game"),t(this,"_gameStage"),t(this,"_savedGame"),t(this,"_gameRulesManager"),t(this,"_mapManager"),t(this,"_powerUpManager"),t(this,"_saveGameManager"),t(this,"_player"),t(this,"_bombGroup"),t(this,"_enemiesGroup"),this._savedGame=null}init(e){this._gameStage=e,this._savedGame=m.getLoadedGame()}create(){this._mapManager=new R({scene:this,world:this.physics.world,gameStage:this._gameStage,savedGame:this._savedGame}),this._bombGroup=new S({scene:this,world:this.physics.world,wallBuilderManager:this._mapManager.wallBuilderManager}),this._player=new u({scene:this,x:60,y:120,bombGroup:this._bombGroup,gameStage:this._gameStage,savedGame:this._savedGame}),this._enemiesGroup=new C({scene:this,world:this.physics.world,player:this._player,wallBuilderManager:this._mapManager.wallBuilderManager,gameStage:this._gameStage,savedGame:this._savedGame}),this._powerUpManager=new I({scene:this,player:this._player,bombGroup:this._bombGroup,gameStage:this._gameStage}),this._gameRulesManager=new U({scene:this,gameStage:this._gameStage,player:this._player,enemiesGroup:this._enemiesGroup}),this._saveGameManager=new m({scene:this,gameStage:this._gameStage,player:this._player,enemiesGroup:this._enemiesGroup,mapManager:this._mapManager}),this.physics.add.collider(this._player,this._mapManager.mapLayer),this.physics.add.collider(this._player,this._bombGroup,void 0,((e,t)=>!e.hasBombPassPowerUp),this),this.physics.add.collider(this._player,this._mapManager.wallsGroup,void 0,((e,t)=>!e.hasWallPassPowerUp),this),this.physics.add.overlap(this._player,this._mapManager.crossroads,((e,t)=>{const s=t;s.body&&(this._player.lastTilePassedPosition={x:Math.floor(s.body.center.x),y:Math.floor(s.body.center.y)})}),((e,t)=>{const s=t;return this._player.validateTileOverlap(s)}),this),this.physics.add.overlap(this._player,this._mapManager.roads,((e,t)=>{const s=t;s.body&&(this._player.lastTilePassedPosition={x:Math.floor(s.body.center.x),y:Math.floor(s.body.center.y)})}),((e,t)=>{const s=t;return this._player.validateTileOverlap(s)}),this),this.physics.add.overlap(this._player,this._enemiesGroup,(()=>{this._gameRulesManager.lose()}),void 0,this),this.physics.add.overlap(this._player,this._bombGroup.explosionGroup,(()=>{this._gameRulesManager.lose()}),(()=>!this._player.hasFlamePassPowerUp),this),this.physics.add.collider(this._enemiesGroup,this._bombGroup,((e,t)=>{e.retraceMotion()}),void 0,this),this.physics.add.collider(this._enemiesGroup,this._mapManager.mapLayer,((e,t)=>{e.retraceMotion()}),void 0,this),this.physics.add.collider(this._enemiesGroup,this._mapManager.wallsGroup,((e,t)=>{e.retraceMotion()}),((e,t)=>!e.enemyData.hasWallPassPowerUp),this),this.physics.add.overlap(this._enemiesGroup,this._mapManager.crossroads,((e,t)=>{var s,i;const a=t,o=e,r={x:(null==(s=a.body)?void 0:s.center.x)??0,y:(null==(i=a.body)?void 0:i.center.y)??0};o.lastCrossroadTouched={x:r.x,y:r.y},o.dispatchMotion()}),((e,t)=>{var s,i;const a=e,o=t,r={x:(null==(s=o.body)?void 0:s.center.x)??0,y:(null==(i=o.body)?void 0:i.center.y)??0};return a.validateCrossroadOverlap({x:r.x,y:r.y})}),this),this.physics.add.overlap(this._bombGroup.explosionGroup,this._bombGroup,((e,t)=>{const s=t;this._bombGroup.exploitByBomb(s)}),void 0,this),this.physics.add.overlap(this._player,this._mapManager.powerUp,((e,t)=>{const s=t,i=s.getData("powerUpId"),a=this._powerUpManager.addPowerUp(i);this._gameRulesManager.score+=a,s.destroy()}),((e,t)=>{const s=e,i=t;if(s.body&&i.body){const e=Math.round(s.body.center.x),t=Math.round(s.body.center.y),a=Math.floor(i.body.center.x),o=Math.floor(i.body.center.y),r=Math.abs(e-a),n=Math.abs(t-o);return r<=5&&n<=5}return!1}),this),this.physics.add.overlap(this._player,this._mapManager.door,(()=>{0===this._enemiesGroup.getLength()&&this._gameRulesManager.win()}),((e,t)=>{const s=e,i=t;return s.body&&i.body&&Math.floor(s.body.center.x)===Math.floor(i.body.center.x)&&Math.floor(s.body.center.y)===Math.floor(i.body.center.y)}),this),this.physics.add.overlap(this._bombGroup.explosionGroup,this._mapManager.door,(()=>{const e=this._mapManager.door;e.disableBody(!1),setTimeout((()=>{e.enableBody(!1)}),3e3),e.body&&this._enemiesGroup.addRandomByPosition(e.body.center.x,e.body.center.y)}),(()=>{var e;const t=this._mapManager.door;return(null==(e=t.body)?void 0:e.enable)&&t.visible}),this),this.physics.add.overlap(this._bombGroup.explosionGroup,this._enemiesGroup,((e,t)=>{const s=t;s.kill(),this._gameRulesManager.score+=s.enemyData.rewardPoints,0===this._enemiesGroup.getTotalUsed()&&this._gameStage.stage===r.FINAL_BONUS&&this._gameRulesManager.win()}),((e,t)=>!t.hasTemporalShield),this),this.physics.add.collider(this._bombGroup.explosionGroup,this._mapManager.wallsGroup,((e,t)=>{const s=t;if(s.kill(),s.getData("hasDoor")){const e=this._mapManager.door;e.disableBody(!1),setTimeout((()=>{e.enableBody(!1)}),3e3),e.setVisible(!0)}if(s.getData("hasPowerUp")&&this._mapManager.powerUp.setVisible(!0),s.body){const e=Math.floor(s.body.center.x),t=Math.floor(s.body.center.y);this._mapManager.wallBuilderManager.addPositionFree(e,t)}}),void 0,this)}update(){this._player.addControlsListener(),this._saveGameManager.addControlsListener()}}const W={type:s.AUTO,width:1024,height:580,parent:"bomberman-container",backgroundColor:"#000000",antialias:!0,physics:{default:"arcade"},scene:[i,o,c,p,K],scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH,width:1024,height:580,min:{width:320,height:180},max:{width:3840,height:2160},fullscreenTarget:"bomberman-container",resizeInterval:250}},k=new s.Game(W);function V(){const e=document.getElementById("bomberman-container");if(e){const t=e.getBoundingClientRect();t.width>0&&t.height>0&&k.scale.refresh()}else k.scale.refresh()}let $;window.addEventListener("resize",(()=>{clearTimeout($),$=window.setTimeout((()=>{V()}),100)})),window.addEventListener("orientationchange",(()=>{setTimeout((()=>{V(),setTimeout((()=>{V()}),100)}),300)})),window.visualViewport&&window.visualViewport.addEventListener("resize",(()=>{clearTimeout($),$=window.setTimeout((()=>{V()}),100)}));
